<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Draw Hanzi</title>
    <style>
      .charlist { display: flex; flex-wrap: wrap; }
      .charimg { border: solid lightgray 1px; }
    </style>

	<script src="pathformer.js"></script>
	<script src="vivus.js"></script>

    <!-- <script src="vivus.min.js"></script> -->
    <script>
      var animated;
      window.onload = function () {
	animated = new Vivus('example', { type: 'oneByOne', duration: 200, pathTimingFunction: Vivus.EASE_IN });
      }
      function drawInput() {
	let testinput = document.getElementById("testinput").value;
	console.log("text is", testinput);
	let characters = testinput.split('');
	characters.forEach(c => drawHanzi(c));
	//animated.reset().play(1)
      }
      function drawHanzi(hanzi) {
	let url = 'https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/' + hanzi + '.json';
	fetch(url)
	  .then(res => res.json())
	  .then(out => {
	    drawMedians(out.medians);
	  })
	  .catch(err => {
	    console.log("error on character", hanzi, "fetching", url);
	    //throw err;
	    drawMedians([]);
	  });
      }
      function drawMedians(medians) {
	console.log('got a character with', medians.length, 'strokes');
	let svg = ['<div class="charimg"><svg height="50" width="50" viewBox="0 0 1024 1024">',
		   '<g transform="scale(1, -1) translate(0, -900)">'];
	medians.forEach(stroke => {
	  let points = [];
	  stroke.forEach(point => points.push(point[0] + ',' + point[1]));
	  svg.push('<path d="M' + points.join(' ') + '" stroke="blue" stroke-width="30" fill="none"/>');
	});
	svg.push('</g>');
	svg.push('</svg></div>');
	document.getElementById('tests').innerHTML += svg.join("\n");
      }
      function animateHanzi() {
	let pathDur = 20;
	//setTimeout(() => {
	  document.querySelectorAll("svg")
	  .forEach(s => {
	    let numstrokes = s.children[0].children.length || 1;
	    console.log("new svg click handler", numstrokes, s);
	      new Vivus(s, { type: 'oneByOne', duration: numstrokes * pathDur, pathTimingFunction: Vivus.EASE_IN });
	      s.onclick =
		z => {
		  console.log("new Vivus", numstrokes * pathDur, s);
		  new Vivus(z.target, { type: 'oneByOne', duration: numstrokes * pathDur, pathTimingFunction: Vivus.EASE_IN })
		  //new Vivus(z.target, { type: 'oneByOne', duration: 400, pathTimingFunction: (x) => { return x < 0.49 ? x*2 : 0.99 } })
		}
	    })
	//}, 1000);
      }
    </script>
    <body>
      <p>The character 我 below is drawn from the "median" points extracted from this JSON:<br>
	<a href="https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/我.json">https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/我.json</a><br>
	from the Hanzi Writer Data Explorer <a href="https://chanind.github.io/hanzi-writer-data/#25105">https://chanind.github.io/hanzi-writer-data/#25105</a><br>
	from the Hanzi Writer Data repository <a href="https://github.com/chanind/hanzi-writer-data">https://github.com/chanind/hanzi-writer-data</a><br>
	from the Make Me a Hanzi project by Shaunak Kishore <a href="https://www.skishore.me/makemeahanzi/">https://www.skishore.me/makemeahanzi/</a>
      </p>
      <div class="charlist"><div class="charimg">
      <svg id="example" height="50" width="50" viewBox="0 0 1024 1024">
	<g transform="scale(1, -1) translate(0, -900)">
	  <path d="M458,627 392,631 336,588 274,552 258,550 253,542 220,530 212,532 203,522" stroke="blue" stroke-width="30" fill="none"/>
	  <path d="M174,404 215,398 241,402 672,514 742,521" stroke="blue" stroke-width="30" fill="none"/>
	  <path d="M323,556 351,542 365,522 361,116 340,67 246,113" stroke="blue" stroke-width="30" fill="none"/>
	  <path d="M100,206 124,195 163,189 492,334" stroke="blue" stroke-width="30" fill="none"/>
	  <path d="M492,807 537,760 538,627 569,435 612,299 676,170 717,112 779,48 817,22 859,12 880,78 891,140 886,147 894,173" stroke="blue" stroke-width="30" fill="none"/>
	  <path d="M723,412 737,365 664,259 594,198 489,142 454,132" stroke="blue" stroke-width="30" fill="none"/>
	  <path d="M657,710 750,668 781,634" stroke="blue" stroke-width="30" fill="none"/>
	</g>
      </svg>
      </div></div>
      <p>Try it out:
	<input type="text" value="道可道非常道" id="testinput"><button onclick="drawInput()">Draw</button>
      </p>
      <p class="charlist" id="tests"></p>
      <p><button onclick="animateHanzi()">Animate</button></p>
    </body>
</html>
